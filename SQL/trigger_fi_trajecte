/* TRIGGER 2 */

-- en iniciar un trajecte : 
-- 		augmenta els llocs docks_lliures de l'estació
-- 		canvia la Estacio_idestacio de la bicicleta (bicicleta.ESTACIO_idESTACIO) a -1  ( -1 xk no pot ser null

DROP TRIGGER IF EXISTS fi_de_trajecte;
DELIMITER //
CREATE TRIGGER fi_de_trajecte 
AFTER update ON trajecte
FOR EACH ROW
BEGIN
	if new.Hora_final != old.Hora_final || old.Hora_final is null then
		/* donem el trajecte per finalitzat, per tant calculem el preu i el posem a la taula de facturació.*/
        insert into 
        facturacio (hora, id_Trajecte 	,	temps,  
							subcripcio,
                            preu 	,
                            id_user )  values         
				(	now(), new.idTrajecte, ( TIMESTAMPDIFF(minute, old.Hora_inici , new.Hora_final) )  ,
							( select tipus_SUBSCRIPCIONS_idSUBSCRIPCIONS from usuari where idUsuari = new.USUARI_idUSUARI  ), 	
							calcula_preu_trajecte(new.idTRAJECTE), 
                            new.USUARI_idUSUARI) ; 
	end if;
    
END
//
DELIMITER ;
 -- call fi_trajecte( 10 , 10 );

